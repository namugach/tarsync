#!/bin/bash

# ===== Tarsync ÏÑ§Ïπò ÎèÑÍµ¨ =====
# ===== Tarsync Installer =====

# Ïú†Ìã∏Î¶¨Ìã∞ Î™®Îìà Î°úÎìú
# Load utility modules
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
source "$PROJECT_ROOT/src/utils/colors.sh"
source "$PROJECT_ROOT/src/utils/log.sh"
source "$PROJECT_ROOT/src/utils/version.sh"

# Î©îÏãúÏßÄ ÏãúÏä§ÌÖú Î°úÎìú
source "$PROJECT_ROOT/config/messages/detect.sh"
source "$PROJECT_ROOT/config/messages/load.sh"
load_tarsync_messages

# ÏÑ§Ïπò ÎîîÎ†âÌÜ†Î¶¨
# Installation directories
PROJECT_DIR="/usr/share/tarsync"
INSTALL_DIR="/usr/local/bin"
COMPLETION_DIR="/etc/bash_completion.d"
ZSH_COMPLETION_DIR="/usr/share/zsh/site-functions"
CONFIG_DIR="/etc/tarsync"

# ===== Í∏∞Î≥∏ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò =====
# ===== Basic Utility Functions =====

check_file_exists() {
    [ -f "$1" ]
}

check_dir_exists() {
    [ -d "$1" ]
}

check_command_exists() {
    command -v "$1" >/dev/null 2>&1
}

create_dir_if_not_exists() {
    [ -d "$1" ] || mkdir -p "$1"
}

# ===== ÏùòÏ°¥ÏÑ± Ï≤¥ÌÅ¨ =====
# ===== Dependency Check =====

# OS Í∞êÏßÄ Ìï®Ïàò
detect_os() {
    local os_name="$(uname -s)"
    case "$os_name" in
        Linux*)
            if command -v apt >/dev/null 2>&1; then
                echo "ubuntu"
            elif command -v yum >/dev/null 2>&1; then
                echo "centos"
            elif command -v dnf >/dev/null 2>&1; then
                echo "fedora"
            else
                echo "linux"
            fi
            ;;
        Darwin*)
            echo "macos"
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

# Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò Î™ÖÎ†πÏñ¥ ÏÉùÏÑ±
get_install_command() {
    local os="$1"
    local missing_tools=("${@:2}")
    
    case "$os" in
        ubuntu)
            echo "sudo apt update && sudo apt install -y ${missing_tools[*]}"
            ;;
        centos)
            echo "sudo yum install -y ${missing_tools[*]}"
            ;;
        fedora)
            echo "sudo dnf install -y ${missing_tools[*]}"
            ;;
        macos)
            # macOSÏóêÏÑúÎäî ÏùºÎ∂Ä ÎèÑÍµ¨Í∞Ä Í∏∞Î≥∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏùÑ Ïàò ÏûàÏùå
            local brew_tools=()
            for tool in "${missing_tools[@]}"; do
                case "$tool" in
                    tar|gzip) continue ;; # macOS Í∏∞Î≥∏ Ìè¨Ìï®
                    *) brew_tools+=("$tool") ;;
                esac
            done
            if [ ${#brew_tools[@]} -gt 0 ]; then
                echo "brew install ${brew_tools[*]}"
            fi
            ;;
        *)
            return 1
            ;;
    esac
}

# ÏàòÎèô ÏÑ§Ïπò ÏïàÎÇ¥
show_manual_install_guide() {
    local missing_tools=("${@}")
    
    echo ""
    log_info "üìã ÏàòÎèô ÏÑ§Ïπò ÏïàÎÇ¥:"
    echo "   Ubuntu/Debian: sudo apt install ${missing_tools[*]}"
    echo "   CentOS/RHEL:   sudo yum install ${missing_tools[*]}"
    echo "   Fedora:        sudo dnf install ${missing_tools[*]}"
    echo "   macOS:         brew install ${missing_tools[*]}"
    echo ""
}

# ÏûêÎèô ÏÑ§Ïπò Ïã§Ìñâ
auto_install_dependencies() {
    local install_cmd="$1"
    
    msg "MSG_INSTALL_DEPS_INSTALLING"
    msg "MSG_INSTALL_DEPS_COMMAND" "$install_cmd"
    echo ""
    
    if eval "$install_cmd"; then
        success_msg "MSG_INSTALL_DEPS_SUCCESS"
        return 0
    else
        error_msg "MSG_INSTALL_DEPS_FAILED"
        return 1
    fi
}

check_required_tools() {
    local required_tools=("tar" "gzip" "rsync" "pv" "bc" "jq")
    local missing_tools=()
    
    # ÎàÑÎùΩÎêú ÎèÑÍµ¨ ÌôïÏù∏
    for tool in "${required_tools[@]}"; do
        if ! check_command_exists "$tool"; then
            missing_tools+=("$tool")
        fi
    done
    
    # Î™®Îì† ÎèÑÍµ¨Í∞Ä ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏúºÎ©¥ Ï¢ÖÎ£å
    if [ ${#missing_tools[@]} -eq 0 ]; then
        return 0
    fi
    
    # ÎàÑÎùΩÎêú ÎèÑÍµ¨ ÏïåÎ¶º
    echo ""
    msg "MSG_INSTALL_DEPS_MISSING_TOOLS" "${missing_tools[*]}"
    
    # OS Í∞êÏßÄ
    local os_type=$(detect_os)
    local install_cmd=$(get_install_command "$os_type" "${missing_tools[@]}")
    
    # ÏûêÎèô ÏÑ§Ïπò Í∞ÄÎä•Ìïú Í≤ΩÏö∞
    if [ -n "$install_cmd" ]; then
        echo ""
        case "$os_type" in
            ubuntu|centos|fedora)
                msg "MSG_INSTALL_LINUX_DETECTED" "$os_type"
                ;;
            macos)
                msg "MSG_INSTALL_MACOS_DETECTED"
                if ! command -v brew >/dev/null 2>&1; then
                    error_msg "MSG_INSTALL_HOMEBREW_MISSING"
                    msg "MSG_INSTALL_HOMEBREW_INSTALL"
                    show_manual_install_guide "${missing_tools[@]}"
                    exit 1
                fi
                ;;
        esac
        
        echo ""
        printf "$(msg MSG_INSTALL_CONFIRM_AUTO_INSTALL)"
        read -r response
        response=${response:-Y}  # Í∏∞Î≥∏Í∞íÏùÑ YÎ°ú ÏÑ§Ï†ï
        
        if [[ "$response" =~ ^[Yy]$ ]]; then
            if auto_install_dependencies "$install_cmd"; then
                # ÏÑ§Ïπò ÌôïÏù∏
                local still_missing=()
                for tool in "${missing_tools[@]}"; do
                    if ! check_command_exists "$tool"; then
                        still_missing+=("$tool")
                    fi
                done
                
                if [ ${#still_missing[@]} -gt 0 ]; then
                    error_msg "MSG_INSTALL_SOME_TOOLS_MISSING" "${still_missing[*]}"
                    show_manual_install_guide "${still_missing[@]}"
                    exit 1
                fi
            else
                show_manual_install_guide "${missing_tools[@]}"
                exit 1
            fi
        else
            show_manual_install_guide "${missing_tools[@]}"
            exit 1
        fi
    else
        # ÏûêÎèô ÏÑ§Ïπò Î∂àÍ∞ÄÎä•Ìïú Í≤ΩÏö∞
        error_msg "MSG_INSTALL_UNSUPPORTED_SYSTEM" "$os_type"
        show_manual_install_guide "${missing_tools[@]}"
        exit 1
    fi
}

check_minimal_requirements() {
    # Bash Î≤ÑÏ†Ñ Ï≤¥ÌÅ¨
    if [ -z "$BASH_VERSION" ]; then
        error_msg "MSG_INSTALL_BASH_REQUIRED"
        exit 1
    fi
    
    # sudo Í∂åÌïú Ï≤¥ÌÅ¨ (Ï†ÑÏó≠ ÏÑ§Ïπò ÌïÑÏöî)
    if [ "$EUID" -ne 0 ]; then
        error_msg "MSG_INSTALL_SUDO_REQUIRED"
        msg "MSG_INSTALL_SUDO_HINT"
        exit 1
    fi
    
    # ÏãúÏä§ÌÖú ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± Í∞ÄÎä• Ïó¨Î∂Ä Ï≤¥ÌÅ¨
    if [ ! -w "/usr/local" ] || [ ! -w "/etc" ] || [ ! -w "/usr/share" ]; then
        error_msg "MSG_INSTALL_WRITE_PERMISSION_ERROR"
        exit 1
    fi
}

# ===== ÏÑ§Ïπò Ìï®ÏàòÎì§ =====
# ===== Installation Functions =====

update_script_paths() {
    sed -i "s|PROJECT_ROOT=.*|PROJECT_ROOT=\"$PROJECT_DIR\"|" "$INSTALL_DIR/tarsync"
}

install_tarsync_script() {
    create_dir_if_not_exists "$INSTALL_DIR"
    create_dir_if_not_exists "$PROJECT_DIR"
    
    cp "$PROJECT_ROOT/bin/tarsync.sh" "$INSTALL_DIR/tarsync"
    chmod +x "$INSTALL_DIR/tarsync"
    
    # VERSION ÌååÏùºÏùÄ PROJECT_DIRÏóê Î≥µÏÇ¨
    cp "$PROJECT_ROOT/bin/VERSION" "$PROJECT_DIR/VERSION"
    
    update_script_paths
    
    if check_file_exists "$INSTALL_DIR/tarsync" && [ -x "$INSTALL_DIR/tarsync" ]; then
        log_info "$(msg MSG_INSTALL_SCRIPT_INSTALLED "$INSTALL_DIR/tarsync")"
    else
        error_msg "MSG_INSTALL_SCRIPT_INSTALL_FAILED"
        return 1
    fi
    
    if check_file_exists "$PROJECT_DIR/VERSION"; then
        log_info "$(msg MSG_INSTALL_VERSION_INSTALLED "$PROJECT_DIR/VERSION")"
    else
        error_msg "MSG_INSTALL_VERSION_INSTALL_FAILED"
        return 1
    fi
}

# Î∞±ÏóÖ ÎîîÎ†âÌÜ†Î¶¨ ÏÑ§Ï†ï
configure_backup_directory() {
    # defaults.shÏóêÏÑú Í∏∞Î≥∏ Î∞±ÏóÖ Í≤ΩÎ°ú Î°úÎìú
    local default_backup_path="/mnt/backup/tarsync"
    if [[ -f "$PROJECT_ROOT/config/defaults.sh" ]]; then
        source "$PROJECT_ROOT/config/defaults.sh"
        default_backup_path="$BACKUP_PATH"
    fi
    
    echo ""
    log_info "$(msg MSG_INSTALL_BACKUP_SETUP)"
    echo ""
    msg MSG_INSTALL_BACKUP_PROMPT
    msg MSG_INSTALL_BACKUP_DEFAULT "$default_backup_path"
    msg MSG_INSTALL_BACKUP_EXAMPLES
    echo ""
    printf "$(msg MSG_INSTALL_BACKUP_INPUT "$default_backup_path")"
    read -r backup_dir
    backup_dir=${backup_dir:-$default_backup_path}
    
    # Í≤ΩÎ°ú Ï†ïÍ∑úÌôî (~ ÌôïÏû•)
    if [[ "$backup_dir" == "~/"* ]]; then
        backup_dir="${HOME}/${backup_dir#~/}"
    elif [[ "$backup_dir" == "~" ]]; then
        backup_dir="${HOME}"
    fi
    
    echo ""
    log_info "$(msg MSG_INSTALL_BACKUP_SELECTED "$backup_dir")"
    
    # ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± ÏãúÎèÑ
    if [[ ! -d "$backup_dir" ]]; then
        msg "MSG_INSTALL_BACKUP_DIR_NOT_EXIST"
        
        if mkdir -p "$backup_dir" 2>/dev/null; then
            success_msg "MSG_INSTALL_BACKUP_DIR_CREATED" "$backup_dir"
        else
            msg "MSG_INSTALL_BACKUP_DIR_CREATE_FAILED"
            echo ""
            msg "MSG_INSTALL_BACKUP_DIR_COMMAND_TIP"
            echo "   sudo mkdir -p '$backup_dir'"
            echo "   sudo chown \$USER:\$USER '$backup_dir'"
            echo ""
            printf "$(msg MSG_INSTALL_BACKUP_DIR_RETRY_PROMPT)"
            read -r retry_response
            
            if [[ "$retry_response" =~ ^[Yy]$ ]]; then
                echo "sudo mkdir -p '$backup_dir' && sudo chown \$USER:\$USER '$backup_dir'" | bash
                if [[ -d "$backup_dir" ]] && [[ -w "$backup_dir" ]]; then
                    success_msg "MSG_INSTALL_BACKUP_DIR_SUDO_SUCCESS"
                else
                    error_msg "MSG_INSTALL_BACKUP_DIR_SUDO_FAILED"
                    exit 1
                fi
            else
                error_msg "MSG_INSTALL_BACKUP_DIR_CANNOT_CREATE"
                exit 1
            fi
        fi
    else
        # Í∏∞Ï°¥ ÎîîÎ†âÌÜ†Î¶¨ Í∂åÌïú ÌôïÏù∏
        if [[ -w "$backup_dir" ]]; then
            success_msg "MSG_INSTALL_BACKUP_DIR_PERMISSIONS_OK"
        else
            msg "MSG_INSTALL_BACKUP_DIR_NO_WRITE" "$backup_dir"
            echo ""
            msg "MSG_INSTALL_BACKUP_DIR_FIX_PERMISSION"
            msg "MSG_INSTALL_BACKUP_DIR_FIX_COMMAND" "$backup_dir"
            echo ""
            printf "$(msg MSG_INSTALL_BACKUP_DIR_FIX_PROMPT)"
            read -r fix_permission
            
            if [[ "$fix_permission" =~ ^[Yy]$ ]]; then
                echo "sudo chown \$USER:\$USER '$backup_dir'" | bash
                
                # Í∂åÌïú ÏàòÏ†ï ÌõÑ Ïû¨ÌôïÏù∏
                if [[ -w "$backup_dir" ]]; then
                    success_msg "MSG_INSTALL_BACKUP_DIR_PERMISSION_FIXED"
                else
                    error_msg "MSG_INSTALL_BACKUP_DIR_FIX_FAILED"
                    echo ""
                    printf "$(msg MSG_INSTALL_BACKUP_DIR_USE_OTHER)"
                    read -r retry_response
                    retry_response=${retry_response:-Y}
                    
                    if [[ "$retry_response" =~ ^[Yy]$ ]]; then
                        echo ""
                        msg "MSG_INSTALL_BACKUP_DIR_ENTER_NEW"
                        printf "$(msg MSG_INSTALL_BACKUP_DIR_INPUT_PROMPT)"
                        read -r new_backup_dir
                        
                        if [[ -n "$new_backup_dir" ]]; then
                            # Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Îã§Ïãú ÏãúÎèÑ (ÏÉà Í≤ΩÎ°úÎ°ú)
                            BACKUP_DIRECTORY=""
                            backup_dir="$new_backup_dir"
                            
                            # Í≤ΩÎ°ú Ï†ïÍ∑úÌôî (~ ÌôïÏû•)
                            if [[ "$backup_dir" == "~/"* ]]; then
                                backup_dir="${HOME}/${backup_dir#~/}"
                            elif [[ "$backup_dir" == "~" ]]; then
                                backup_dir="${HOME}"
                            fi
                            
                            msg "MSG_INSTALL_BACKUP_DIR_NEW_PATH" "$backup_dir"
                            
                            # ÏÉà Í≤ΩÎ°úÎ°ú Îã§Ïãú Í≤ÄÏ¶ù (Í∞ÑÎã®Ìïú Ïû¨Í∑Ä)
                            if [[ ! -d "$backup_dir" ]]; then
                                if mkdir -p "$backup_dir" 2>/dev/null; then
                                    success_msg "MSG_INSTALL_BACKUP_DIR_NEW_SUCCESS" "$backup_dir"
                                else
                                    error_msg "MSG_INSTALL_BACKUP_DIR_NEW_FAILED"
                                    exit 1
                                fi
                            elif [[ ! -w "$backup_dir" ]]; then
                                error_msg "MSG_INSTALL_BACKUP_DIR_NEW_NO_WRITE" "$backup_dir"
                                exit 1
                            else
                                success_msg "MSG_INSTALL_BACKUP_DIR_NEW_PERMISSION_OK"
                            fi
                        else
                            error_msg "MSG_INSTALL_BACKUP_DIR_INVALID"
                            exit 1
                        fi
                    else
                        error_msg "MSG_INSTALL_BACKUP_DIR_NO_AVAILABLE"
                        exit 1
                    fi
                fi
            else
                error_msg "MSG_INSTALL_BACKUP_DIR_PERMISSION_ERROR"
                exit 1
            fi
        fi
    fi
    
    # Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ï†ÄÏû•
    BACKUP_DIRECTORY="$backup_dir"
    
    echo ""
    log_info "$(msg MSG_INSTALL_BACKUP_SETUP_COMPLETE)"
}

copy_project_files() {
    create_dir_if_not_exists "$PROJECT_DIR/src"
    create_dir_if_not_exists "$PROJECT_DIR/config"
    
    cp -r "$PROJECT_ROOT/src/"* "$PROJECT_DIR/src/"
    cp -r "$PROJECT_ROOT/config/"* "$PROJECT_DIR/config/"
    
    # ÏãúÏä§ÌÖú ÏÑ§Ï†ï ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
    create_dir_if_not_exists "$CONFIG_DIR"

    # ÏÑ§Ï†ï ÌååÏùº ÏÉùÏÑ± (Ïñ∏Ïñ¥ ÏÑ†ÌÉù Î∞è Î∞±ÏóÖ ÎîîÎ†âÌÜ†Î¶¨ Î∞òÏòÅ)
    cat > "$CONFIG_DIR/settings.env" << EOF
# tarsync Í∏∞Î≥∏ ÏÑ§Ï†ï
TARSYNC_LANG=${selected_lang:-en}
LANGUAGE=${selected_lang:-en}
BACKUP_DIR=${BACKUP_DIRECTORY:-/mnt/backup/tarsync}
LOG_LEVEL=info
EOF
    
    log_info "$(msg MSG_INSTALL_FILES_COPIED)"
    log_info "$(msg MSG_INSTALL_BACKUP_LOCATION "${BACKUP_DIRECTORY:-/mnt/backup}")"
}


install_completions() {
    # ÏûêÎèôÏôÑÏÑ± ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
    create_dir_if_not_exists "$COMPLETION_DIR"
    create_dir_if_not_exists "$ZSH_COMPLETION_DIR"
    
    # ÏûêÎèôÏôÑÏÑ± ÌååÏùº Î≥µÏÇ¨
    cp "$PROJECT_ROOT/src/completion/bash.sh" "$COMPLETION_DIR/tarsync"
    chmod +x "$COMPLETION_DIR/tarsync"
    
    cp "$PROJECT_ROOT/src/completion/zsh.sh" "$ZSH_COMPLETION_DIR/_tarsync"
    chmod +x "$ZSH_COMPLETION_DIR/_tarsync"
    
    log_info "$(msg MSG_INSTALL_COMPLETION_INSTALLED)"
}

configure_bash_completion() {
    # Ï†ÑÏó≠ ÏÑ§ÏπòÏóêÏÑúÎäî /etc/bash_completion.d/ Ïóê ÏÑ§ÏπòÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Î°úÎìúÎê®
    log_info "$(msg MSG_INSTALL_COMPLETION_BASH_GLOBAL)"
}

configure_zsh_completion() {
    # Ï†ÑÏó≠ ÏÑ§ÏπòÏóêÏÑúÎäî /usr/share/zsh/site-functions/ Ïóê ÏÑ§ÏπòÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Î°úÎìúÎê®  
    log_info "$(msg MSG_INSTALL_COMPLETION_ZSH_GLOBAL)"
}

update_path() {
    # Ï†ÑÏó≠ ÏÑ§ÏπòÏóêÏÑúÎäî /usr/local/binÏù¥ Ïù¥ÎØ∏ PATHÏóê Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏñ¥ÏÑú Î≥ÑÎèÑ ÏÑ§Ï†ï Î∂àÌïÑÏöî
    log_info "$(msg MSG_INSTALL_PATH_NOT_NEEDED)"
}

# ===== Ïñ∏Ïñ¥ ÏÑ†ÌÉù Ìï®Ïàò =====
# ===== Language Selection Functions =====

# Ïñ∏Ïñ¥ ÌååÏùºÏóêÏÑú ÏΩîÎìúÏôÄ Ïù¥Î¶Ñ Ï∂îÏ∂ú
process_language_file() {
    local lang_file="$1"
    local code=""
    local name=""
    
    if [ -f "$lang_file" ]; then
        # Ïñ∏Ïñ¥ ÏΩîÎìú Ï∂îÏ∂ú (LANG_CODE Î≥ÄÏàòÏóêÏÑú)
        code=$(grep "^LANG_CODE=" "$lang_file" 2>/dev/null | cut -d'=' -f2 | tr -d "\"'")
        # Ïñ∏Ïñ¥ Ïù¥Î¶Ñ Ï∂îÏ∂ú (LANG_NAME Î≥ÄÏàòÏóêÏÑú)
        name=$(grep "^LANG_NAME=" "$lang_file" 2>/dev/null | cut -d'=' -f2 | tr -d "\"'")
        
        if [ -n "$code" ] && [ -n "$name" ]; then
            langs+=("$code")
            lang_names+=("$name")
            
            if [ "$code" = "en" ]; then  # tarsync default is English (globalization)
                default_idx=$i
            fi
            
            i=$((i+1))
        fi
    fi
}

# ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïñ∏Ïñ¥ Ï∞æÍ∏∞
find_available_languages() {
    langs=()
    lang_names=()
    default_idx=0
    i=0
    
    log_info "Finding available languages..."
    
    # Ïñ∏Ïñ¥ Î©îÏãúÏßÄ ÌååÏùºÎì§ Í≤ÄÏÇ¨
    for lang_file in "$PROJECT_ROOT/config/messages"/*.sh; do
        if [[ "$(basename "$lang_file")" != "detect.sh" && "$(basename "$lang_file")" != "load.sh" ]]; then
            process_language_file "$lang_file"
        fi
    done
    
    # Ïñ∏Ïñ¥Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
    if [ ${#langs[@]} -eq 0 ]; then
        langs=("en" "ko")
        lang_names=("English" "ÌïúÍµ≠Ïñ¥")
        default_idx=0  # English is default (globalization)
    fi
}

# Ïñ∏Ïñ¥ ÏòµÏÖò ÌëúÏãú
display_language_options() {
    echo ""
    log_info "$(msg MSG_INSTALL_SELECT_LANGUAGE)"
    echo "   0. $(msg MSG_INSTALL_CANCEL)"
    
    for i in "${!langs[@]}"; do
        local default_mark=""
        if [ $i -eq $default_idx ]; then
            default_mark=$(msg "MSG_INSTALL_DEFAULT_MARK")
        fi
        echo "   $((i+1)). ${lang_names[$i]}${default_mark}"
    done
}

# Ïñ∏Ïñ¥ ÏÑ†ÌÉù ÏûÖÎ†• Ï≤òÎ¶¨
handle_language_selection() {
    echo ""
    printf "$(msg MSG_INSTALL_LANGUAGE_INPUT "$(( ${#langs[@]} - 1 ))")"
    read -r lang_choice
    
    if [ "$lang_choice" = "0" ]; then
        log_info "$(msg MSG_INSTALL_CANCELLED)"
        exit 0
    fi
    
    process_language_choice
}

# ÏÑ†ÌÉùÎêú Ïñ∏Ïñ¥ Ï≤òÎ¶¨
process_language_choice() {
    if [[ "$lang_choice" =~ ^[0-9]+$ ]] && [ "$lang_choice" -ge 1 ] && [ "$lang_choice" -le "${#langs[@]}" ]; then
        set_selected_language
    else
        set_default_language
    fi
    
    prepare_language_settings
}

# ÏÑ†ÌÉùÎêú Ïñ∏Ïñ¥ ÏÑ§Ï†ï
set_selected_language() {
    local idx=$((lang_choice-1))
    selected_lang="${langs[$idx]}"
    selected_name="${lang_names[$idx]}"
    
    TARSYNC_LANG="$selected_lang"
    export TARSYNC_LANG
    
    log_info "$(msg MSG_INSTALL_LANGUAGE_SELECTED "$selected_name" "$selected_lang")"
}

# Í∏∞Î≥∏ Ïñ∏Ïñ¥ ÏÑ§Ï†ï
set_default_language() {
    local default_lang="${langs[$default_idx]}"
    local default_name="${lang_names[$default_idx]}"
    
    selected_lang="$default_lang"
    selected_name="$default_name"
    
    TARSYNC_LANG="$default_lang"
    export TARSYNC_LANG
    
    log_info "$(msg MSG_INSTALL_LANGUAGE_INVALID "$default_name" "$default_lang")"
}

# Ïñ∏Ïñ¥ ÏÑ§Ï†ï Ï§ÄÎπÑ
prepare_language_settings() {
    # ÏÑ†ÌÉùÎêú Ïñ∏Ïñ¥Î°ú Î©îÏãúÏßÄ ÏãúÏä§ÌÖú Îã§Ïãú Î°úÎìú
    load_tarsync_messages
    
    log_info "$(msg MSG_INSTALL_LANGUAGE_CONFIGURED)"
}

# Î©îÏù∏ Ïñ∏Ïñ¥ ÏÑ†ÌÉù Ìï®Ïàò
setup_language() {
    find_available_languages
    display_language_options  
    handle_language_selection
}

# ===== Í≤ÄÏ¶ù Ìï®Ïàò =====
# ===== Verification Functions =====

verify_installation() {
    if check_file_exists "$INSTALL_DIR/tarsync" && [ -x "$INSTALL_DIR/tarsync" ]; then
        show_success_message
    else
        error_msg "MSG_INSTALL_VERIFY_FAILED"
        error_msg "MSG_INSTALL_SCRIPT_NOT_FOUND" "$INSTALL_DIR/tarsync"
        exit 1
    fi
}

show_success_message() {
    # Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Î≤ÑÏ†Ñ Ïú†Ìã∏Î¶¨Ìã∞ ÏÇ¨Ïö©)
    local version=$(get_version)
    
    echo ""
    success_msg "MSG_INSTALL_SUCCESS_HEADER" "$version"
    echo ""
    msg "MSG_INSTALL_LOCATIONS_HEADER"
    msg "MSG_INSTALL_LOCATION_EXECUTABLE" "$INSTALL_DIR/tarsync"
    msg "MSG_INSTALL_LOCATION_VERSION" "$PROJECT_DIR/VERSION"
    msg "MSG_INSTALL_LOCATION_LIBRARY" "$PROJECT_DIR"
    msg "MSG_INSTALL_LOCATION_BASH_COMPLETION" "$COMPLETION_DIR/tarsync"
    msg "MSG_INSTALL_LOCATION_ZSH_COMPLETION" "$ZSH_COMPLETION_DIR/_tarsync"
    echo ""
    
    # ÌôòÍ≤Ω Í∞êÏßÄ Î∞è ÏûêÎèôÏôÑÏÑ± Ï¶âÏãú ÏÇ¨Ïö© ÏòµÏÖò Ï†úÍ≥µ
    offer_immediate_completion_setup
}

# ÏÇ¨Ïö©Ïûê Ïâò ÌôòÍ≤Ω Í∞êÏßÄ
detect_user_shell() {
    if [ -n "$BASH_VERSION" ]; then
        echo "bash"
    elif [ -n "$ZSH_VERSION" ]; then
        echo "zsh"
    else
        # fallback: $SHELL Î≥ÄÏàò ÏÇ¨Ïö©
        case "$SHELL" in
            */bash) echo "bash" ;;
            */zsh) echo "zsh" ;;
            *) echo "unknown" ;;
        esac
    fi
}

# ÏâòÎ≥Ñ ÎßûÏ∂§ Î™ÖÎ†πÏñ¥ Ï†úÏãú
show_shell_specific_completion_commands() {
    local user_shell=$(detect_user_shell)
    
    echo ""
    case "$user_shell" in
        bash)
            echo -e "   ${CYAN}üêö Bash environment detected${NC}"
            echo ""
            echo "   Run one of the following:"
            echo -e "   ${YELLOW}1) source ~/.bashrc${NC}              # Reload configuration file"
            echo -e "   ${YELLOW}2) source /etc/bash_completion${NC}   # Load completion directly"  
            echo -e "   ${YELLOW}3) exec bash${NC}                     # Start new shell session (recommended)"
            ;;
        zsh)
            echo -e "   ${CYAN}üêö ZSH environment detected${NC}"
            echo ""
            echo "   Run one of the following:"
            echo -e "   ${YELLOW}1) source ~/.zshrc${NC}               # Reload configuration file"
            echo -e "   ${YELLOW}2) autoload -U compinit && compinit${NC}  # Reinitialize completion"
            echo -e "   ${YELLOW}3) exec zsh${NC}                      # Start new shell session (recommended)"
            ;;
        *)
            echo -e "   ${CYAN}üêö Shell environment: $SHELL${NC}"
            echo ""
            echo "   Run one of the following:"
            echo -e "   ${YELLOW}1) source ~/.bashrc${NC}              # Load Bash configuration"
            echo -e "   ${YELLOW}2) source /etc/bash_completion${NC}   # Load completion directly"
            echo -e "   ${YELLOW}3) exec \$SHELL${NC}                  # Start new shell session (recommended)"
            ;;
    esac
    echo ""
    printf "   ${DIM}$(msg MSG_INSTALL_COMPLETION_COPY_TIP)${NC}\n"
}

# ÏûêÎèôÏôÑÏÑ± Ï¶âÏãú ÏÇ¨Ïö©ÏùÑ ÏúÑÌïú ÏÑ†ÌÉùÍ∂å Ï†úÍ≥µ
offer_immediate_completion_setup() {
    echo ""
    log_info "$(msg MSG_INSTALL_COMPLETION_IMMEDIATE)"
    
    # Docker/Ïª®ÌÖåÏù¥ÎÑà ÌôòÍ≤Ω Í∞êÏßÄ
    local is_container=false
    if [ -f /.dockerenv ] || [ -n "${container:-}" ] || grep -q 'docker\|lxc' /proc/1/cgroup 2>/dev/null; then
        is_container=true
    fi
    
    # Ïª®ÌÖåÏù¥ÎÑà ÌôòÍ≤ΩÏùº ÎïåÎßå Ï∂îÍ∞Ä Î©îÏãúÏßÄ Ï∂úÎ†•
    if [ "$is_container" = true ]; then
        printf "   ${YELLOW}$(msg MSG_INSTALL_CONTAINER_ENV_DETECTED)${NC}\n"
    fi
    
    # ÏâòÎ≥Ñ ÎßûÏ∂§ Î™ÖÎ†πÏñ¥ ÏïàÎÇ¥ (Ìï≠ÏÉÅ Ïã§Ìñâ)
    show_shell_specific_completion_commands
    
    echo ""
    msg "MSG_INSTALL_USAGE_EXAMPLES"
    msg "MSG_INSTALL_USAGE_HELP"
    msg "MSG_INSTALL_USAGE_VERSION"
    msg "MSG_INSTALL_USAGE_BACKUP"
    msg "MSG_INSTALL_USAGE_LIST"
    echo ""
    success_msg "MSG_INSTALL_COMPLETION_TIP"
}

confirm_installation() {
    echo ""
    log_info "$(msg MSG_INSTALL_CONFIRM_PROCEED)"
    read -r confirmation
    confirmation=${confirmation:-Y}  # Í∏∞Î≥∏Í∞íÏùÑ YÎ°ú ÏÑ§Ï†ï
    
    if [[ ! $confirmation =~ ^[Yy]$ ]]; then
        log_info "$(msg MSG_INSTALL_CANCELLED)"
        exit 0
    fi
}

# bash-completion ÏÑ§Ïπò Î∞è ÌôúÏÑ±Ìôî
# Install and enable bash-completion
setup_bash_completion() {
    msg "MSG_INSTALL_BASH_COMPLETION_SETUP"
    
    # bash-completion Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò Ïó¨Î∂Ä ÌôïÏù∏
    if ! dpkg -l | grep -q "bash-completion"; then
        msg "MSG_INSTALL_BASH_COMPLETION_INSTALLING"
        
        # OS Í∞êÏßÄÌï¥ÏÑú Ï†ÅÏ†àÌïú ÏÑ§Ïπò Î™ÖÎ†πÏñ¥ ÏÇ¨Ïö©
        local os_type=$(detect_os)
        case "$os_type" in
            ubuntu)
                apt update -qq && apt install -y bash-completion
                ;;
            centos)
                yum install -y bash-completion
                ;;
            fedora)
                dnf install -y bash-completion
                ;;
            *)
                log_warn "ÏûêÎèô ÏÑ§ÏπòÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏãúÏä§ÌÖúÏûÖÎãàÎã§: $os_type"
                log_info "Îã§Ïùå Î™ÖÎ†πÏñ¥Î°ú ÏàòÎèô ÏÑ§ÏπòÌï¥Ï£ºÏÑ∏Ïöî:"
                echo "   Ubuntu/Debian: apt install bash-completion"
                echo "   CentOS/RHEL:   yum install bash-completion"
                echo "   Fedora:        dnf install bash-completion"
                return 1
                ;;
        esac
        
        if dpkg -l | grep -q "bash-completion"; then
            success_msg "MSG_INSTALL_BASH_COMPLETION_SUCCESS"
        else
            error_msg "MSG_INSTALL_BASH_COMPLETION_FAILED"
            return 1
        fi
    else
        msg "MSG_INSTALL_BASH_COMPLETION_INSTALLED"
    fi
    
    # /etc/bash.bashrcÏóêÏÑú bash completion ÌôúÏÑ±Ìôî
    if [ -f "/etc/bash.bashrc" ]; then
        # Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if grep -q "^if ! shopt -oq posix; then" /etc/bash.bashrc; then
            msg "MSG_INSTALL_BASH_COMPLETION_ACTIVE"
        else
            msg "MSG_INSTALL_BASH_COMPLETION_ACTIVATING"
            
            # Ï†ÑÏ≤¥ bash completion Î∏îÎ°ù ÌôúÏÑ±Ìôî (Ï£ºÏÑù Ï†úÍ±∞)
            sed -i 's/^#if ! shopt -oq posix; then/if ! shopt -oq posix; then/' /etc/bash.bashrc
            sed -i 's/^#  if \[ -f \/usr\/share\/bash-completion\/bash_completion \]/  if [ -f \/usr\/share\/bash-completion\/bash_completion ]/' /etc/bash.bashrc
            sed -i 's/^#    \. \/usr\/share\/bash-completion\/bash_completion/    . \/usr\/share\/bash-completion\/bash_completion/' /etc/bash.bashrc
            sed -i 's/^#  elif \[ -f \/etc\/bash_completion \]/  elif [ -f \/etc\/bash_completion ]/' /etc/bash.bashrc
            sed -i 's/^#    \. \/etc\/bash_completion/    . \/etc\/bash_completion/' /etc/bash.bashrc
            sed -i 's/^#  fi/  fi/' /etc/bash.bashrc
            sed -i 's/^#fi/fi/' /etc/bash.bashrc
            
            # ÌôúÏÑ±Ìôî ÌôïÏù∏
            if grep -q "^if ! shopt -oq posix; then" /etc/bash.bashrc; then
                success_msg "MSG_INSTALL_BASH_COMPLETION_ACTIVATED"
            else
                error_msg "MSG_INSTALL_BASH_COMPLETION_ACTIVATE_FAILED"
                return 1
            fi
        fi
    else
        log_warn "$(msg MSG_INSTALL_BASH_COMPLETION_BASHRC_NOT_FOUND)"
        return 1
    fi
    
    log_success "$(msg MSG_INSTALL_BASH_COMPLETION_COMPLETE)"
}

# ===== Î©îÏù∏ ÏÑ§Ïπò ÌîÑÎ°úÏÑ∏Ïä§ =====
# ===== Main Installation Process =====

main() {
    log_info "Initializing installation..."
    check_minimal_requirements
    
    log_info "Checking for existing installation..."
    if check_dir_exists "$PROJECT_DIR"; then
        log_info "Existing installation directory found: $PROJECT_DIR"
    fi
    
    log_info "Checking required dependencies..."
    check_required_tools
    log_info "All dependencies satisfied"
    
    # Ïñ∏Ïñ¥ ÏÑ†ÌÉù
    setup_language
    
    # Ïñ∏Ïñ¥ ÏÑ†ÌÉù ÌõÑ Ìó§Îçî Ï∂úÎ†•
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë           $(msg MSG_INSTALL_HEADER_TITLE)            ‚ïë${NC}"
    echo -e "${CYAN}‚ïë      $(msg MSG_INSTALL_HEADER_SUBTITLE)          ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    
    # ÏµúÏ¢Ö ÌôïÏù∏
    confirm_installation
    
    # Ïã§Ï†ú ÏÑ§Ïπò ÏãúÏûë
    echo ""
    log_info "$(msg MSG_INSTALL_STARTING)"
    echo ""
    
    # Í∏∞Ï°¥ ÏÑ§Ïπò Ï†úÍ±∞
    if check_dir_exists "$PROJECT_DIR"; then
        log_info "$(msg MSG_INSTALL_REMOVING_EXISTING)"
        rm -rf "$PROJECT_DIR"
    fi
    
    # ÌååÏùº ÏÑ§Ïπò
    log_info "$(msg MSG_INSTALL_FILES)"
    configure_backup_directory
    copy_project_files || exit 1
    install_tarsync_script || exit 1
    
    # ÏûêÎèôÏôÑÏÑ± ÏÑ§Ïπò
    msg "MSG_INSTALL_COMPLETION_INSTALLING"
    install_completions || exit 1
    
    # bash-completion ÏãúÏä§ÌÖú ÌôúÏÑ±Ìôî
    setup_bash_completion || exit 1
    
    configure_bash_completion
    configure_zsh_completion
    
    # PATH ÏóÖÎç∞Ïù¥Ìä∏
    msg "MSG_INSTALL_PATH_UPDATING"
    update_path
    
    # ÏÑ§Ïπò ÌôïÏù∏
    log_info "$(msg MSG_INSTALL_VERIFYING)"
    verify_installation
}

# Î©îÏù∏ Ìï®Ïàò Ïã§Ìñâ
main 